# Apache Configuration for nextjs.synergyinfinity.id
# This file should be placed in aaPanel Apache vhost configuration
# Path: /www/server/panel/vhost/apache/nextjs.synergyinfinity.id.conf

<VirtualHost *:80>
    ServerAdmin webmaster@example.com
    ServerName nextjs.synergyinfinity.id
    ServerAlias www.nextjs.synergyinfinity.id
    
    ErrorLog "/www/wwwlogs/nextjs.synergyinfinity.id-error_log"
    CustomLog "/www/wwwlogs/nextjs.synergyinfinity.id-access_log" combined

    # Redirect to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

<VirtualHost *:443>
    ServerAdmin webmaster@example.com
    ServerName nextjs.synergyinfinity.id
    ServerAlias www.nextjs.synergyinfinity.id
    
    ErrorLog "/www/wwwlogs/nextjs.synergyinfinity.id-error_log"
    CustomLog "/www/wwwlogs/nextjs.synergyinfinity.id-access_log" combined
    
    #SSL
    SSLEngine On
    SSLCertificateFile /www/server/panel/vhost/cert/nextjs.synergyinfinity.id/fullchain.pem
    SSLCertificateKeyFile /www/server/panel/vhost/cert/nextjs.synergyinfinity.id/privkey.pem
    SSLCipherSuite EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5:ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP:+eNULL
    SSLProtocol All -SSLv2 -SSLv3 -TLSv1
    SSLHonorCipherOrder On
    
    # Enable CORS Headers with credentials
    Header always set Access-Control-Allow-Origin "https://nextjs.synergyinfinity.id"
    Header always set Access-Control-Allow-Methods "POST, GET, OPTIONS, DELETE, PUT, PATCH"
    Header always set Access-Control-Allow-Headers "x-requested-with, Content-Type, origin, authorization, accept, client-security-token, X-XSRF-TOKEN, X-CSRF-TOKEN"
    Header always set Access-Control-Allow-Credentials "true"
    Header always set Access-Control-Max-Age "86400"
    
    # Handle preflight OPTIONS requests
    RewriteEngine On
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=200,L]
    
    # Backend API Proxy - Forward /api to external backend
    ProxyPreserveHost On
    ProxyRequests Off
    
    # API Routes - Proxy to Backend at axum.synergyinfinity.id
    <Location /api>
        ProxyPass https://axum.synergyinfinity.id/api
        ProxyPassReverse https://axum.synergyinfinity.id/api
        ProxyPassReverseCookieDomain axum.synergyinfinity.id nextjs.synergyinfinity.id
        ProxyPassReverseCookiePath /api /api
        
        # Additional headers for proxying
        RequestHeader set X-Forwarded-Proto "https"
        RequestHeader set X-Forwarded-Port "443"
        RequestHeader set X-Forwarded-Host "nextjs.synergyinfinity.id"
        RequestHeader set Origin "https://axum.synergyinfinity.id"
        
        # Preserve cookies for CSRF
        ProxyPreserveHost On
        
        # Increase timeout and buffer for file uploads
        ProxyTimeout 600
        LimitRequestBody 10485760
    </Location>
    
    # Frontend - Proxy to Next.js (Port 3000)
    ProxyPass /api !
    ProxyPass / http://127.0.0.1:3000/
    ProxyPassReverse / http://127.0.0.1:3000/
    
    # WebSocket support for Next.js hot reload
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*)           ws://127.0.0.1:3000/$1 [P,L]
    RewriteCond %{HTTP:Upgrade} !=websocket [NC]
    RewriteRule /(.*)           http://127.0.0.1:3000/$1 [P,L]
    
    # Proxy settings
    ProxyTimeout 300
    ProxyPassMatch ^/(.*\.hot-update\.json)$ http://127.0.0.1:3000/$1
    
    #DENY FILES
    <Files ~ (\.user.ini|\.htaccess|\.git|\.env|\.svn|\.project|LICENSE|README.md)$>
       Order allow,deny
       Deny from all
    </Files>
</VirtualHost>
